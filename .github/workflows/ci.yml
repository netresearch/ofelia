name: CI

on:
  push:
    branches: [main]
    tags: ['**']
  pull_request:
    branches: [main]
  merge_group:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: "${{ github.repository_owner }}/ofelia"

jobs:
  unit-smoke:
    name: smoke tests (fast feedback)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          git diff --exit-code -- go.mod go.sum

      - name: Smoke tests (core packages only)
        run: |
          # Run fast smoke tests on core packages first for quick feedback
          go test -race -timeout=60s ./core/... ./config/... ./logging/...

  unit-full:
    name: unit tests (full suite)
    runs-on: ubuntu-latest
    needs: unit-smoke
    strategy:
      matrix:
        package: [cli, core, config, logging, metrics, middlewares, web]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Unit tests ${{ matrix.package }}
        run: |
          go test -race -covermode=atomic -coverprofile=coverage-${{ matrix.package }}.out ./${{ matrix.package }}/...

      - name: Upload coverage
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: coverage-${{ matrix.package }}
          path: coverage-${{ matrix.package }}.out

  unit-coverage:
    name: coverage analysis
    runs-on: ubuntu-latest
    needs: unit-full
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Download coverage artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: Merge coverage reports
        run: |
          # Merge all coverage files
          echo "mode: atomic" > coverage.out
          find . -name "coverage-*.out" -exec tail -n +2 {} \; >> coverage.out

      - name: Coverage summary
        run: go tool cover -func=coverage.out | tail -n 1 || true

      - name: Enforce coverage threshold
        run: |
          THRESHOLD=60.0
          TOTAL=$(go tool cover -func=coverage.out | awk '/^total:/ {gsub("%","",$3); print $3}')
          echo "Total coverage: ${TOTAL}% (threshold ${THRESHOLD}%)"
          awk -v t="$THRESHOLD" -v a="$TOTAL" 'BEGIN { if (a+0 < t+0) { exit 1 } }'

      - name: Upload merged coverage
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: coverage-merged
          path: coverage.out

      - name: Upload to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: coverage.out
          fail_ci_if_error: false
          verbose: true

  # Summary job for branch protection - required status check
  unit-tests-summary:
    name: unit tests
    runs-on: ubuntu-latest
    needs: [unit-full, unit-coverage]
    steps:
      - name: All unit tests passed
        run: echo "All unit tests completed successfully"

  lint:
    name: golangci-lint (all linters)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Download modules
        run: go mod download

      - name: Warm build cache
        run: go build ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@9fae48acfc02a90574d7c304a1758ef9895495fa # v7.0.1
        with:
          version: v2.9.0
          args: --timeout=5m
          only-new-issues: false

  fuzz:
    name: fuzz tests
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Run fuzz tests
        run: |
          # Run each fuzz test for 30 seconds
          go test -fuzz=FuzzBuildFromString -fuzztime=30s ./cli/...
          go test -fuzz=FuzzDockerLabels -fuzztime=30s ./cli/...

  vulncheck:
    name: govulncheck
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
      - name: Run govulncheck and fail only if fix available
        run: |
          set +e
          TMP_OUT=$(mktemp)
          go run golang.org/x/vuln/cmd/govulncheck@v1.1.4 ./... | tee "$TMP_OUT"
          set -e
          # Fail only if any vulnerability reports a concrete fixed version (not "N/A")
          if grep -E "^\s*Fixed in:\s+" "$TMP_OUT" | grep -v "Fixed in: N/A" >/dev/null; then
            echo "govulncheck: vulnerabilities with available fixes detected; failing job"
            exit 1
          fi
          echo "govulncheck: no vulnerabilities with available fixes (or only unfixed advisories)"
          exit 0

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@ce3cf9537a52e8119d91fd484ab5b8a807627bf8 # v4.6.0
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, MPL-2.0, CC0-1.0, Unlicense
          # Packages with compound SPDX expressions (e.g. "Apache-2.0 AND BSD-3-Clause")
          # that dependency-review-action cannot match via allow-licenses
          allow-dependencies-licenses: >-
            pkg:golang/go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp,
            pkg:golang/go.opentelemetry.io/otel,
            pkg:golang/go.opentelemetry.io/otel/metric,
            pkg:golang/go.opentelemetry.io/otel/trace,
            pkg:golang/golang.org/x/crypto,
            pkg:golang/golang.org/x/sys,
            pkg:golang/golang.org/x/text
          comment-summary-in-pr: always

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Install go-licenses
        # Pin by hash for OpenSSF Scorecard compliance
        run: go install github.com/google/go-licenses@5348b744d0983d85713295ea08a20cca1654a45e # v1.6.0

      - name: Check licenses
        run: |
          "$(go env GOPATH)/bin/go-licenses" check ./... 2>&1 | tee license-report.txt
          # Fail on forbidden licenses (GPL-3.0, AGPL-3.0)
          if grep -qE "(GPL-3.0|AGPL-3.0)" license-report.txt; then
            echo "::error::Found forbidden license (GPL-3.0 or AGPL-3.0)"
            exit 1
          fi

      - name: Generate license report
        run: |
          "$(go env GOPATH)/bin/go-licenses" report ./... > licenses.csv 2>/dev/null || true
        continue-on-error: true

      - name: Upload license report
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: license-report
          path: |
            license-report.txt
            licenses.csv
        if: always()

  integration:
    name: integration tests
    needs: unit-coverage
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Confirm Docker
        run: docker info

      - name: Integration tests
        run: go test -tags=integration -timeout=5m ./...

  codeql:
    # skip merge queue branches as they disappear before the upload step
    if: (github.event_name != 'push') || (!startsWith(github.ref, 'refs/heads/gh-readonly-queue/'))
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Initialize CodeQL
        uses: github/codeql-action/init@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        with:
          languages: go

      - name: Download dependencies
        run: go mod download

      - name: Build
        uses: github/codeql-action/autobuild@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3

  gosec:
    name: gosec
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Install gosec
        # Pin by hash for OpenSSF Scorecard compliance
        run: go install github.com/securego/gosec/v2/cmd/gosec@5d1a18b12ab7a9858baf9b7cffa903028792ed17 # v2.22.0

      - name: Run gosec
        run: |
          echo "GOPATH=$(go env GOPATH)"
          "$(go env GOPATH)/bin/gosec" ./...

  gitleaks:
    name: gitleaks
    # gitleaks-action doesn't support merge_group events
    # Skip for fork PRs as secrets are not available
    if: github.event_name != 'merge_group' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork != true)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_KEY }}

  build-binaries:
    name: Build ${{ matrix.suffix }} binary
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: "386"
            suffix: linux-386
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: "6"
            suffix: linux-armv6
          - goos: linux
            goarch: arm
            goarm: "7"
            suffix: linux-armv7
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binary
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: go build -trimpath -ldflags="-s -w -X 'main.version=edge' -X 'main.build=${{ github.sha }}'" -o ofelia-${{ matrix.suffix }} .

      - name: Upload binary
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: binary-${{ matrix.suffix }}
          path: ofelia-${{ matrix.suffix }}
          retention-days: 1

  build_image:
    name: Build and push container image
    # push container image only for commits on the main branch to keep
    # ghcr.io from accumulating untagged images on every branch push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-binaries]
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: "${{ github.repository_owner }}/ofelia:edge"
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download pre-built binaries
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: binary-*
          merge-multiple: true
          path: bin

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to the Container registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        # GHCR reads description from manifest index annotations, not image labels
        # See: https://docs.docker.com/build/metadata/annotations/
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/ofelia
          # Generate OCI Image annotations
          # See: https://github.com/opencontainers/image-spec/blob/main/annotations.md
          tags: |
            type=edge,branch=main
          # Static labels/annotations (dynamic ones like created, revision are auto-generated)
          # Note: base.name is set in Dockerfile with full digest for accuracy
          labels: |
            org.opencontainers.image.title=Ofelia
            org.opencontainers.image.description=A docker job scheduler (based on mcuadros/ofelia)
            org.opencontainers.image.vendor=Netresearch DTT GmbH
            org.opencontainers.image.authors=Netresearch DTT GmbH <info@netresearch.de>
            org.opencontainers.image.documentation=https://github.com/netresearch/ofelia#readme

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: push
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64
          provenance: true
          sbom: true

      - name: Install crane
        uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4

      - name: Tag platform-specific images
        run: |
          set -euo pipefail
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/ofelia"

          # Get the manifest and extract platform digests
          for platform in linux/386 linux/amd64 linux/arm/v6 linux/arm/v7 linux/arm64; do
            # Convert platform to tag suffix (linux/arm/v7 -> arm-v7)
            suffix=$(echo "$platform" | sed 's|linux/||; s|/|-|g')

            # Get the digest for this specific platform
            digest=$(crane manifest "$IMAGE:edge" | jq -r ".manifests[] | select(.platform.os + \"/\" + .platform.architecture + (if .platform.variant then \"/\" + .platform.variant else \"\" end) == \"$platform\") | .digest")

            if [ -n "$digest" ] && [ "$digest" != "null" ]; then
              echo "Tagging $IMAGE:edge-$suffix from $digest"
              crane tag "$IMAGE@$digest" "edge-$suffix"
            fi
          done

      - name: Install Cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Sign container image
        run: |
          set -euo pipefail
          cosign sign --yes ${{ env.REGISTRY }}/${{ github.repository_owner }}/ofelia:edge@${{ steps.push.outputs.digest }}

  hadolint:
    name: hadolint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: Dockerfile

  workflow-lint:
    name: actionlint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: reviewdog/action-actionlint@723b43e281169876cbcd247431484753fb341f0d # v1.65.0

  trivy:
    name: trivy scan (fs)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: fs
          ignore-unfixed: true
          format: sarif
          output: trivy-results.sarif
          vuln-type: 'os,library'
          severity: CRITICAL,HIGH
          exit-code: 1
      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        if: always()  # Upload even if vulnerabilities found (exit-code: 1)
        with:
          sarif_file: trivy-results.sarif
