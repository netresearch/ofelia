name: Release (SLSA Level 3)

on:
  release:
    types: [published]

permissions: read-all

jobs:
  # Output release tag for dependent jobs
  resolve-tag:
    name: Resolve Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Output release tag
        id: tag
        run: echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"

  # SLSA Level 3 builds with provenance
  build:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - linux-386
          - linux-amd64
          - linux-arm64
          - linux-armv6
          - linux-armv7
          - darwin-amd64
          - darwin-arm64
          - windows-amd64
    permissions:
      id-token: write
      contents: write
      actions: read
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@5a775b367a56d5bd118a224a811bba288150a563 # v2.0.0
    with:
      go-version-file: go.mod
      config-file: .slsa-goreleaser/${{ matrix.target }}.yml
      evaluated-envs: "VERSION:${{ github.ref_name }}, COMMIT:${{ github.sha }}"
      upload-assets: true
      draft-release: false
      private-repository: false

  # Generate SBOMs for all binaries
  sbom:
    name: Generate SBOMs
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@55dc4ee22412511ee8c3142cbea40418e6cec693 # v0.17.8

      - name: Download all release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          gh release download "$RELEASE_TAG" --dir dist --pattern "ofelia-*"

      - name: Generate SBOMs
        run: |
          set -euo pipefail
          for binary in dist/ofelia-*; do
            if [[ ! "$binary" =~ \.intoto\.jsonl$ ]] && [[ ! "$binary" =~ \.sbom\.json$ ]]; then
              echo "Generating SBOM for $binary"
              syft "$binary" -o spdx-json="${binary}.sbom.json"
            fi
          done

      - name: Upload SBOMs to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          for sbom in dist/*.sbom.json; do
            if [[ -f "$sbom" ]]; then
              echo "Uploading $sbom"
              gh release upload "$RELEASE_TAG" "$sbom" --clobber
            fi
          done

  # Generate checksums
  checksums:
    name: Generate Checksums
    needs: [resolve-tag, build, sbom]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download all release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          gh release download "$RELEASE_TAG" --dir dist
          rm -f dist/checksums.txt*

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          # Only checksum actual binaries (exclude provenance and SBOM metadata)
          find . -maxdepth 1 -type f -name "ofelia-*" \
            ! -name "*.intoto.jsonl" \
            ! -name "*.sbom.json" \
            -exec sha256sum {} + > checksums.txt
          cat checksums.txt

      - name: Install Cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Sign checksums
        run: |
          set -euo pipefail
          cosign sign-blob --yes \
            --output-certificate dist/checksums.txt.pem \
            --output-signature dist/checksums.txt.sig \
            dist/checksums.txt

      - name: Upload checksums and signatures
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          gh release upload "$RELEASE_TAG" \
            dist/checksums.txt \
            dist/checksums.txt.pem \
            dist/checksums.txt.sig \
            --clobber

  # Append verification instructions to release notes
  release-notes:
    name: Update Release Notes
    needs: [resolve-tag, checksums]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Append verification instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail

          # Get existing release notes
          gh release view "$RELEASE_TAG" --json body --jq '.body' > /tmp/notes.md

          # Check if verification section already exists
          if grep -q "## Verification" /tmp/notes.md; then
            echo "Verification section already exists, skipping"
            exit 0
          fi

          # Append verification instructions (indented for YAML, then stripped)
          cat > /tmp/verification.md << 'VERIFICATION_EOF'

          ## Verification

          All binaries include SLSA Level 3 provenance attestations.

          ### Verify binary provenance
          ```bash
          slsa-verifier verify-artifact ofelia-linux-amd64 \
            --provenance-path ofelia-linux-amd64.intoto.jsonl \
            --source-uri github.com/netresearch/ofelia
          ```

          ### Verify checksums signature
          ```bash
          cosign verify-blob \
            --certificate checksums.txt.pem \
            --signature checksums.txt.sig \
            --certificate-identity "https://github.com/netresearch/ofelia/.github/workflows/release-slsa.yml@refs/tags/RELEASE_TAG_PLACEHOLDER" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            checksums.txt
          ```
          VERIFICATION_EOF

          # Strip indentation and replace placeholder
          sed 's/^          //' /tmp/verification.md | sed "s/RELEASE_TAG_PLACEHOLDER/${RELEASE_TAG}/g" >> /tmp/notes.md

          gh release edit "$RELEASE_TAG" --notes-file /tmp/notes.md

  # Container images (runs after binary builds succeed)
  docker:
    name: Build and Push Container Images
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/ofelia
      VERSION: ${{ needs.resolve-tag.outputs.tag }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to Container registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        # GHCR reads description from manifest index annotations, not image labels
        # See: https://docs.docker.com/build/metadata/annotations/
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # Generate OCI Image annotations
          # See: https://github.com/opencontainers/image-spec/blob/main/annotations.md
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
          # Static labels/annotations (dynamic ones like created, revision, version are auto-generated)
          # Note: base.name is set in Dockerfile with full digest for accuracy
          labels: |
            org.opencontainers.image.title=Ofelia
            org.opencontainers.image.description=A docker job scheduler (based on mcuadros/ofelia)
            org.opencontainers.image.vendor=Netresearch DTT GmbH
            org.opencontainers.image.authors=Netresearch DTT GmbH <info@netresearch.de>
            org.opencontainers.image.documentation=https://github.com/netresearch/ofelia#readme

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: push
        with:
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64
          build-args: |
            CGO_ENABLED=0
          provenance: true
          sbom: true

      - name: Install crane
        uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4

      - name: Tag platform-specific images
        run: |
          set -euo pipefail
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          VERSION="${{ steps.meta.outputs.version }}"

          # Get the manifest and extract platform digests, then tag each platform
          for platform in linux/386 linux/amd64 linux/arm/v6 linux/arm/v7 linux/arm64; do
            # Convert platform to tag suffix (linux/arm/v7 -> arm-v7)
            suffix=$(echo "$platform" | sed 's|linux/||; s|/|-|g')

            # Get the digest for this specific platform
            digest=$(crane manifest "$IMAGE:$VERSION" | jq -r ".manifests[] | select(.platform.os + \"/\" + .platform.architecture + (if .platform.variant then \"/\" + .platform.variant else \"\" end) == \"$platform\") | .digest")

            if [ -n "$digest" ] && [ "$digest" != "null" ]; then
              echo "Tagging $IMAGE:$VERSION-$suffix and $IMAGE:latest-$suffix from $digest"
              crane tag "$IMAGE@$digest" "$VERSION-$suffix"
              crane tag "$IMAGE@$digest" "latest-$suffix"
            fi
          done

      - name: Install Cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Sign container images
        run: |
          set -euo pipefail
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest@${{ steps.push.outputs.digest }}
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}@${{ steps.push.outputs.digest }}

  # Notify PRs and issues included in this release
  notify-released:
    name: Notify Released PRs/Issues
    needs: [resolve-tag, docker, release-notes]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    env:
      RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Label and comment on released PRs/Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Get previous release tag
          PREV_TAG=$(gh release list --json tagName --jq '.[].tagName' | grep -A1 "^${RELEASE_TAG}$" | tail -1)
          if [[ -z "$PREV_TAG" || "$PREV_TAG" == "$RELEASE_TAG" ]]; then
            echo "No previous release found, using first commit"
            PREV_TAG=$(gh api repos/${{ github.repository }}/commits --jq '.[0].sha' | head -1)
          fi

          echo "Processing PRs between $PREV_TAG and $RELEASE_TAG"

          # Create release label if it doesn't exist
          gh label create "released:${RELEASE_TAG}" \
            --color "0e8a16" \
            --description "Included in ${RELEASE_TAG} release" 2>/dev/null || true

          # Get all PR numbers from commits between releases
          PR_NUMBERS=$(gh api "repos/${{ github.repository }}/compare/${PREV_TAG}...${RELEASE_TAG}" \
            --jq '[.commits[].commit.message | capture("#(?<n>[0-9]+)"; "g") | .n] | unique | .[]' 2>/dev/null || echo "")

          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG}"

          for pr in $PR_NUMBERS; do
            # Check if it's a merged PR
            PR_STATE=$(gh pr view "$pr" --json state --jq '.state' 2>/dev/null || echo "")
            if [[ "$PR_STATE" != "MERGED" ]]; then
              echo "PR #${pr} is not merged (state: ${PR_STATE:-unknown}), skipping"
              continue
            fi

            # Check if already labeled
            if gh pr view "$pr" --json labels --jq '.labels[].name' 2>/dev/null | grep -q "^released:${RELEASE_TAG}$"; then
              echo "PR #${pr} already labeled, skipping"
              continue
            fi

            echo "Processing PR #${pr}"

            # Add label
            gh pr edit "$pr" --add-label "released:${RELEASE_TAG}" 2>/dev/null || true

            # Add comment (use unquoted heredoc for natural variable expansion)
            cat > /tmp/pr_comment.md << PR_EOF
            ðŸš€ **Released in [${RELEASE_TAG}](${RELEASE_URL})**

            Thank you for your contribution! ðŸ™

            This is now available in the latest release. Please test and verify everything works as expected in your environment.

            If you encounter any issues, please open a new issue.
            PR_EOF
            sed -i 's/^            //' /tmp/pr_comment.md
            gh pr comment "$pr" --body-file /tmp/pr_comment.md 2>/dev/null || true

            # Process linked issues
            LINKED_ISSUES=$(gh pr view "$pr" --json closingIssuesReferences --jq '.closingIssuesReferences[].number' 2>/dev/null || echo "")
            for issue in $LINKED_ISSUES; do
              # Check if already labeled
              if gh issue view "$issue" --json labels --jq '.labels[].name' 2>/dev/null | grep -q "^released:${RELEASE_TAG}$"; then
                echo "Issue #${issue} already labeled, skipping"
                continue
              fi

              echo "Processing Issue #${issue}"

              # Add label
              gh issue edit "$issue" --add-label "released:${RELEASE_TAG}" 2>/dev/null || true

              # Add comment (use unquoted heredoc for natural variable expansion)
              cat > /tmp/issue_comment.md << ISSUE_EOF
              ðŸš€ **Released in [${RELEASE_TAG}](${RELEASE_URL})**

              Thank you for reporting this! ðŸ™

              The fix/feature is now available in the latest release. Please update and verify everything works as expected.

              If the issue persists or you find related problems, please open a new issue.
              ISSUE_EOF
              sed -i 's/^              //' /tmp/issue_comment.md
              gh issue comment "$issue" --body-file /tmp/issue_comment.md 2>/dev/null || true
            done
          done

          echo "Notification complete for ${RELEASE_TAG}"

      - name: Update release notes with issues link
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Get existing release notes
          gh release view "$RELEASE_TAG" --json body --jq '.body' > /tmp/notes.md

          # Check if "Included in this release" section already exists
          if grep -q "## Included in this release" /tmp/notes.md; then
            echo "Issues link section already exists, skipping"
            exit 0
          fi

          # Add link to filtered issues/PRs
          FILTER_URL="${{ github.server_url }}/${{ github.repository }}/issues?q=label%3Areleased%3A${RELEASE_TAG}+is%3Aclosed"

          echo "" >> /tmp/notes.md
          echo "---" >> /tmp/notes.md
          echo "" >> /tmp/notes.md
          echo "## Included in this release" >> /tmp/notes.md
          echo "" >> /tmp/notes.md
          echo "[View all PRs and Issues included in this release](${FILTER_URL})" >> /tmp/notes.md
          echo "" >> /tmp/notes.md

          # Update release notes
          gh release edit "$RELEASE_TAG" --notes-file /tmp/notes.md
          echo "Updated release notes with issues filter link"
