name: Release (SLSA Level 3)

on:
  release:
    types: [published]

permissions: read-all

jobs:
  # Output release tag for dependent jobs
  resolve-tag:
    name: Resolve Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Output release tag
        id: tag
        run: echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"

  # Generate changelog from conventional commits
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@4a4a951bc43fafe41cd2348d181853f52356bee7 # v4.4.2
        with:
          config: .cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md

      - name: Upload changelog
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: changelog
          path: CHANGELOG.md

  # SLSA Level 3 builds with provenance
  build:
    name: Build ${{ matrix.target }}
    needs: changelog
    strategy:
      fail-fast: false
      matrix:
        target:
          - linux-386
          - linux-amd64
          - linux-arm64
          - linux-armv6
          - linux-armv7
          - darwin-amd64
          - darwin-arm64
          - windows-amd64
    permissions:
      id-token: write
      contents: write
      actions: read
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@v2.1.0
    with:
      go-version-file: go.mod
      config-file: .slsa-goreleaser/${{ matrix.target }}.yml
      evaluated-envs: "VERSION:${{ github.ref_name }}, COMMIT:${{ github.sha }}"
      upload-assets: true
      draft-release: false

  # Generate SBOMs for all binaries
  sbom:
    name: Generate SBOMs
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@55dc4ee22412511ee8c3142cbea40418e6cec693 # v0.17.8

      - name: Download all release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          gh release download "$RELEASE_TAG" --dir dist --pattern "ofelia-*"

      - name: Generate SBOMs
        run: |
          set -euo pipefail
          for binary in dist/ofelia-*; do
            if [[ ! "$binary" =~ \.intoto\.jsonl$ ]] && [[ ! "$binary" =~ \.sbom\.json$ ]]; then
              echo "Generating SBOM for $binary"
              syft "$binary" -o spdx-json="${binary}.sbom.json"
            fi
          done

      - name: Upload SBOMs to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          for sbom in dist/*.sbom.json; do
            if [[ -f "$sbom" ]]; then
              echo "Uploading $sbom"
              gh release upload "$RELEASE_TAG" "$sbom" --clobber
            fi
          done

  # Generate checksums
  checksums:
    name: Generate Checksums
    needs: [resolve-tag, build, sbom]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download all release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          gh release download "$RELEASE_TAG" --dir dist
          rm -f dist/checksums.txt*

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          # Only checksum actual binaries (exclude provenance and SBOM metadata)
          find . -maxdepth 1 -type f -name "ofelia-*" \
            ! -name "*.intoto.jsonl" \
            ! -name "*.sbom.json" \
            -exec sha256sum {} + > checksums.txt
          cat checksums.txt

      - name: Install Cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Sign checksums
        run: |
          set -euo pipefail
          cosign sign-blob --yes \
            --output-certificate dist/checksums.txt.pem \
            --output-signature dist/checksums.txt.sig \
            dist/checksums.txt

      - name: Upload checksums and signatures
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          gh release upload "$RELEASE_TAG" \
            dist/checksums.txt \
            dist/checksums.txt.pem \
            dist/checksums.txt.sig \
            --clobber

  # Update release notes with changelog
  release-notes:
    name: Update Release Notes
    needs: [resolve-tag, changelog, checksums]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download changelog
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: changelog

      - name: Update release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.resolve-tag.outputs.tag }}
        run: |
          set -euo pipefail
          # Append verification instructions (indented to satisfy YAML, then stripped)
          cat > /tmp/verification.md << 'VERIFICATION'
          ---

          ## Verification

          All binaries include SLSA Level 3 provenance attestations.

          ### Verify binary provenance
          ```bash
          slsa-verifier verify-artifact ofelia-linux-amd64 \
            --provenance-path ofelia-linux-amd64.intoto.jsonl \
            --source-uri github.com/netresearch/ofelia
          ```

          ### Verify checksums signature
          ```bash
          cosign verify-blob \
            --certificate checksums.txt.pem \
            --signature checksums.txt.sig \
            --certificate-identity "https://github.com/netresearch/ofelia/.github/workflows/release-slsa.yml@refs/tags/<TAG>" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            checksums.txt
          ```
          VERIFICATION
          sed 's/^          //' /tmp/verification.md | sed "s/<TAG>/${RELEASE_TAG}/g" >> CHANGELOG.md

          gh release edit "$RELEASE_TAG" \
            --notes-file CHANGELOG.md

  # Container images (runs after binary builds succeed)
  docker:
    name: Build and Push Container Images
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/ofelia
      VERSION: ${{ needs.resolve-tag.outputs.tag }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to Container registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # Generate OCI Image annotations
          # See: https://github.com/opencontainers/image-spec/blob/main/annotations.md
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
          # Static labels/annotations (dynamic ones like created, revision, version are auto-generated)
          # Note: base.name is set in Dockerfile with full digest for accuracy
          labels: |
            org.opencontainers.image.title=Ofelia
            org.opencontainers.image.description=A docker job scheduler (based on mcuadros/ofelia)
            org.opencontainers.image.vendor=Netresearch DTT GmbH
            org.opencontainers.image.authors=Netresearch DTT GmbH <info@netresearch.de>
            org.opencontainers.image.documentation=https://github.com/netresearch/ofelia#readme

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: push
        with:
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64
          build-args: |
            CGO_ENABLED=0
          provenance: true
          sbom: true

      - name: Install crane
        uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4

      - name: Tag platform-specific images
        run: |
          set -euo pipefail
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          VERSION="${{ steps.meta.outputs.version }}"

          # Get the manifest and extract platform digests, then tag each platform
          for platform in linux/386 linux/amd64 linux/arm/v6 linux/arm/v7 linux/arm64; do
            # Convert platform to tag suffix (linux/arm/v7 -> arm-v7)
            suffix=$(echo "$platform" | sed 's|linux/||; s|/|-|g')

            # Get the digest for this specific platform
            digest=$(crane manifest "$IMAGE:$VERSION" | jq -r ".manifests[] | select(.platform.os + \"/\" + .platform.architecture + (if .platform.variant then \"/\" + .platform.variant else \"\" end) == \"$platform\") | .digest")

            if [ -n "$digest" ] && [ "$digest" != "null" ]; then
              echo "Tagging $IMAGE:$VERSION-$suffix and $IMAGE:latest-$suffix from $digest"
              crane tag "$IMAGE@$digest" "$VERSION-$suffix"
              crane tag "$IMAGE@$digest" "latest-$suffix"
            fi
          done

      - name: Install Cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Sign container images
        run: |
          set -euo pipefail
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest@${{ steps.push.outputs.digest }}
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}@${{ steps.push.outputs.digest }}

      - name: Update package description
        env:
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          curl -sS -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/orgs/${OWNER}/packages/container/ofelia" \
            -d '{"description":"A docker job scheduler (based on mcuadros/ofelia)"}'
